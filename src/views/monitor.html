<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Monitor del Servidor - SIRH</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #0a0a0a;
        min-height: 100vh;
        padding: 20px;
        color: #e5e7eb;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      .header {
        background: linear-gradient(135deg, #1a1a1a 0%, #2d1a23 100%);
        padding: 35px;
        border-radius: 12px;
        border: 1px solid #9d2449;
        margin-bottom: 30px;
        text-align: center;
        box-shadow: 0 10px 40px rgba(157, 36, 73, 0.2);
      }

      .header h1 {
        color: #ffffff;
        font-size: 2.8em;
        margin-bottom: 8px;
        font-weight: 700;
        letter-spacing: -1px;
      }

      .header p {
        color: #9ca3af;
        font-size: 1.05em;
        font-weight: 400;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: linear-gradient(135deg, #1f1f1f 0%, #2a2a2a 100%);
        padding: 30px;
        border-radius: 10px;
        border: 1px solid #333;
        text-align: center;
        transition: all 0.3s ease;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
        position: relative;
        overflow: hidden;
      }

      .stat-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #9d2449, #c92d5f, #9d2449);
      }

      .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 30px rgba(157, 36, 73, 0.4);
        border-color: #9d2449;
      }

      .stat-card h3 {
        color: #9ca3af;
        font-size: 0.85em;
        text-transform: uppercase;
        margin-bottom: 15px;
        letter-spacing: 1.5px;
        font-weight: 600;
      }

      .stat-card .value {
        color: #ffffff;
        font-size: 3em;
        font-weight: 700;
        letter-spacing: -1.5px;
        margin-bottom: 8px;
      }

      .stat-card .label {
        color: #6b7280;
        font-size: 0.85em;
        font-weight: 500;
      }

      .stat-card.success .value {
        color: #d1d5db;
      }
      .stat-card.success::before {
        background: linear-gradient(90deg, #4b5563, #6b7280, #4b5563);
      }

      .stat-card.redirects .value {
        color: #9ca3af;
      }
      .stat-card.redirects::before {
        background: linear-gradient(90deg, #374151, #4b5563, #374151);
      }

      .stat-card.client-error .value {
        color: #e5e7eb;
      }
      .stat-card.client-error::before {
        background: linear-gradient(90deg, #525252, #737373, #525252);
      }
      .stat-card.client-error {
        cursor: pointer;
      }

      .stat-card.server-error .value {
        color: #fca5a5;
      }
      .stat-card.server-error::before {
        background: linear-gradient(90deg, #7f1d1d, #991b1b, #7f1d1d);
      }
      .stat-card.server-error {
        cursor: pointer;
      }

      .stat-card.total .value {
        color: #ffffff;
      }
      .stat-card.total::before {
        background: linear-gradient(90deg, #9d2449, #d63468, #9d2449);
      }

      .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .chart-card {
        background: linear-gradient(135deg, #1f1f1f 0%, #2a2a2a 100%);
        padding: 30px;
        border-radius: 10px;
        border: 1px solid #333;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
      }

      .chart-card h2 {
        color: #ffffff;
        margin-bottom: 25px;
        font-size: 1.25em;
        font-weight: 600;
        letter-spacing: -0.5px;
        padding-bottom: 15px;
        border-bottom: 2px solid #9d2449;
      }

      .chart-container {
        position: relative;
        height: 300px;
      }

      .table-card {
        background: linear-gradient(135deg, #1f1f1f 0%, #2a2a2a 100%);
        padding: 30px;
        border-radius: 10px;
        border: 1px solid #333;
        overflow-x: auto;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
        margin-bottom: 30px;
      }

      .table-card h2 {
        color: #ffffff;
        margin-bottom: 25px;
        font-size: 1.25em;
        font-weight: 600;
        letter-spacing: -0.5px;
        padding-bottom: 15px;
        border-bottom: 2px solid #9d2449;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th {
        background: #2d2d2d;
        color: #9ca3af;
        padding: 15px;
        text-align: left;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75em;
        letter-spacing: 1.2px;
        border-bottom: 2px solid #404040;
      }

      td {
        padding: 15px;
        border-bottom: 1px solid #2d2d2d;
        color: #d1d5db;
        font-size: 0.9em;
      }

      tr:hover {
        background: #252525;
      }

      .status-badge {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 6px;
        font-size: 0.8em;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .status-success {
        background: #374151;
        color: #d1d5db;
        border: 1px solid #4b5563;
      }

      .status-redirect {
        background: #1f2937;
        color: #9ca3af;
        border: 1px solid #374151;
      }

      .status-client-error {
        background: #3f3f3f;
        color: #e5e7eb;
        border: 1px solid #525252;
      }

      .status-server-error {
        background: #450a0a;
        color: #fca5a5;
        border: 1px solid #7f1d1d;
      }

      /* Estilos para badges de Agenda */
      .agenda-badge {
        padding: 6px 14px;
        border-radius: 6px;
        font-size: 0.85em;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .estado-completado {
        background: #064e3b;
        color: #6ee7b7;
        border: 1px solid #10b981;
      }

      .estado-error {
        background: #7f1d1d;
        color: #fca5a5;
        border: 1px solid #dc2626;
      }

      .estado-iniciado {
        background: #1e3a8a;
        color: #93c5fd;
        border: 1px solid #3b82f6;
      }

      .estado-omitido {
        background: #3f3f3f;
        color: #d1d5db;
        border: 1px solid #6b7280;
      }

      .loading {
        text-align: center;
        color: #9ca3af;
        font-size: 1.3em;
        padding: 60px;
      }

      .refresh-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        background: linear-gradient(135deg, #9d2449 0%, #b82d54 100%);
        color: #ffffff;
        border: 1px solid #c92d5f;
        padding: 15px 28px;
        border-radius: 8px;
        font-size: 0.95em;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 10px 30px rgba(157, 36, 73, 0.5);
        transition: all 0.3s ease;
        letter-spacing: 0.3px;
      }

      .refresh-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 15px 40px rgba(157, 36, 73, 0.7);
        background: linear-gradient(135deg, #b82d54 0%, #d63468 100%);
      }

      .method-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 0.75em;
        font-weight: 700;
        margin-right: 10px;
        letter-spacing: 0.5px;
      }

      .method-GET {
        background: #374151;
        color: #d1d5db;
        border: 1px solid #4b5563;
      }

      .method-POST {
        background: #9d2449;
        color: #ffffff;
        border: 1px solid #c92d5f;
      }

      .method-PUT {
        background: #525252;
        color: #f3f4f6;
        border: 1px solid #737373;
      }

      .method-DELETE {
        background: #7f1d1d;
        color: #fca5a5;
        border: 1px solid #991b1b;
      }

      .method-PATCH {
        background: #3f3f46;
        color: #e4e4e7;
        border: 1px solid #52525b;
      }

      /* Modal de Errores */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.85);
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .modal-content {
        background: linear-gradient(135deg, #1f1f1f 0%, #2a2a2a 100%);
        margin: 3% auto;
        padding: 0;
        border: 2px solid #9d2449;
        border-radius: 12px;
        width: 90%;
        max-width: 900px;
        box-shadow: 0 20px 60px rgba(157, 36, 73, 0.5);
        animation: slideDown 0.3s ease;
      }

      @keyframes slideDown {
        from {
          transform: translateY(-50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .modal-header {
        padding: 25px 30px;
        background: linear-gradient(135deg, #9d2449 0%, #b82d54 100%);
        color: white;
        border-radius: 10px 10px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-header h2 {
        margin: 0;
        font-size: 1.5em;
        font-weight: 600;
      }

      .close {
        color: #ffffff;
        font-size: 32px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        line-height: 1;
      }

      .close:hover,
      .close:focus {
        color: #fca5a5;
        transform: scale(1.2);
      }

      .modal-body {
        padding: 30px;
        max-height: 500px;
        overflow-y: auto;
      }

      .error-item {
        background: #1a1a1a;
        border: 1px solid #333;
        border-left: 4px solid #dc2626;
        padding: 20px;
        margin-bottom: 15px;
        border-radius: 8px;
        transition: all 0.3s ease;
      }

      .error-item:hover {
        border-left-color: #9d2449;
        transform: translateX(5px);
      }

      .error-item .error-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .error-item .error-code {
        background: #7f1d1d;
        color: #fca5a5;
        padding: 5px 12px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.9em;
      }

      .error-item .error-time {
        color: #9ca3af;
        font-size: 0.85em;
      }

      .error-item .error-url {
        color: #d1d5db;
        font-weight: 600;
        margin-bottom: 8px;
        word-break: break-all;
      }

      .error-item .error-method {
        display: inline-block;
        background: #9d2449;
        color: white;
        padding: 3px 10px;
        border-radius: 4px;
        font-size: 0.8em;
        font-weight: 600;
        margin-right: 10px;
      }

      .error-item .error-description {
        color: #9ca3af;
        font-size: 0.9em;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #333;
      }

      /* Bot√≥n secreto de limpieza */
      .secret-clean-btn {
        position: fixed;
        bottom: 90px;
        right: 30px;
        width: 50px;
        height: 50px;
        background: transparent;
        border: none;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .secret-clean-btn.visible {
        opacity: 1;
      }

      .secret-clean-btn svg {
        width: 100%;
        height: 100%;
        filter: drop-shadow(0 0 10px rgba(220, 38, 38, 0.5));
      }

      .secret-clean-btn:hover svg {
        filter: drop-shadow(0 0 15px rgba(220, 38, 38, 0.8));
        transform: scale(1.1);
      }

      .no-errors {
        text-align: center;
        color: #6b7280;
        padding: 40px;
        font-size: 1.1em;
      }

      @media (max-width: 768px) {
        .charts-grid {
          grid-template-columns: 1fr;
        }

        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
        }

        .refresh-btn {
          bottom: 20px;
          right: 20px;
          padding: 12px 20px;
          font-size: 0.9em;
        }

        .modal-content {
          width: 95%;
          margin: 5% auto;
        }

        .secret-clean-btn {
          bottom: 80px;
          right: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Monitor del Servidor SIRH</h1>
        <p>Sistema de monitoreo en tiempo real</p>
      </div>

      <div id="loading" class="loading">Cargando datos del servidor...</div>

      <div id="content" style="display: none">
        <!-- Tarjetas de estad√≠sticas -->
        <div class="stats-grid">
          <div class="stat-card total">
            <h3>Total de Solicitudes</h3>
            <div class="value" id="stat-total">0</div>
            <div class="label">Todas las peticiones</div>
          </div>
          <div class="stat-card success">
            <h3>Solicitudes Exitosas</h3>
            <div class="value" id="stat-2xx">0</div>
            <div class="label">C√≥digos 2xx</div>
          </div>
          <div class="stat-card redirects">
            <h3>Redirecciones</h3>
            <div class="value" id="stat-3xx">0</div>
            <div class="label">C√≥digos 3xx</div>
          </div>
          <div class="stat-card client-error">
            <h3>Errores del Cliente</h3>
            <div class="value" id="stat-4xx">0</div>
            <div class="label">C√≥digos 4xx</div>
          </div>
          <div class="stat-card server-error">
            <h3>Errores del Servidor</h3>
            <div class="value" id="stat-5xx">0</div>
            <div class="label">C√≥digos 5xx</div>
          </div>
        </div>

        <!-- Gr√°ficas -->
        <div class="charts-grid">
          <div class="chart-card">
            <h2>Distribuci√≥n por C√≥digo de Estado</h2>
            <div class="chart-container">
              <canvas id="statusChart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <h2>Distribuci√≥n por M√©todo HTTP</h2>
            <div class="chart-container">
              <canvas id="methodChart"></canvas>
            </div>
          </div>
        </div>

        <div class="chart-card">
          <h2>Endpoints M√°s Utilizados</h2>
          <div class="chart-container">
            <canvas id="endpointsChart"></canvas>
          </div>
        </div>

        <!-- Tabla de registros recientes -->
        <div class="table-card">
          <h2>Registros Recientes de HTTP</h2>
          <table id="logsTable">
            <thead>
              <tr>
                <th>Fecha/Hora</th>
                <th>M√©todo</th>
                <th>URL</th>
                <th>Estado</th>
                <th>Duraci√≥n</th>
                <th>IP</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- Tabla de tareas autom√°ticas (Agenda) -->
        <div class="table-card">
          <h2>Tareas Autom√°ticas (Scheduler)</h2>
          <table id="agendaLogsTable">
            <thead>
              <tr>
                <th>Fecha/Hora</th>
                <th>Tarea</th>
                <th>Estado</th>
                <th>Mensaje</th>
                <th>Registros</th>
                <th>Exitosos</th>
                <th>Errores</th>
                <th>Duraci√≥n</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <button class="refresh-btn" onclick="loadData()">Actualizar Datos</button>
    </div>

    <!-- Modal para mostrar errores -->
    <div id="errorModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalTitle">Errores del Servidor</h2>
          <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body" id="modalBody">
          <!-- Los errores se cargar√°n din√°micamente aqu√≠ -->
        </div>
      </div>
    </div>

    <!-- Bot√≥n secreto para limpiar logs (aparece al hacer triple click en el logo) -->
    <button class="secret-clean-btn" id="secretCleanBtn" onclick="cleanLogs()">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="none"
        stroke="#dc2626"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <polyline points="3 6 5 6 21 6"></polyline>
        <path
          d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
        ></path>
        <line x1="10" y1="11" x2="10" y2="17"></line>
        <line x1="14" y1="11" x2="14" y2="17"></line>
      </svg>
    </button>

    <script>
      let charts = {};

      async function loadData() {
        try {
          // Cargar estad√≠sticas
          const statsRes = await fetch("/api/monitor/stats");
          const stats = await statsRes.json();

          // Actualizar tarjetas de estad√≠sticas
          document.getElementById("stat-total").textContent = stats.total;
          document.getElementById("stat-2xx").textContent =
            stats.byStatus["2xx"];
          document.getElementById("stat-3xx").textContent =
            stats.byStatus["3xx"];
          document.getElementById("stat-4xx").textContent =
            stats.byStatus["4xx"];
          document.getElementById("stat-5xx").textContent =
            stats.byStatus["5xx"];

          // Cargar logs recientes HTTP (l√≠mite 50)
          const logsRes = await fetch("/api/monitor/recent?limit=50");
          const logs = await logsRes.json();

          // Cargar logs de Agenda
          const agendaLogsRes = await fetch(
            "/api/monitor/agenda/logs?limit=50"
          );
          const agendaLogs = await agendaLogsRes.json();

          renderTable(logs);
          renderAgendaTable(agendaLogs);
          renderCharts(stats);

          document.getElementById("loading").style.display = "none";
          document.getElementById("content").style.display = "block";
        } catch (error) {
          console.error("Error cargando datos:", error);
          document.getElementById("loading").innerHTML =
            '<span style="color: #ef4444;">Error al cargar los datos del servidor</span>';
        }
      }

      function renderCharts(stats) {
        // Destruir gr√°ficas existentes
        Object.values(charts).forEach((chart) => chart.destroy());
        charts = {};

        // Configuraci√≥n base para gr√°ficas con tema oscuro
        const chartOptions = {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: "bottom",
              labels: {
                padding: 15,
                font: {
                  size: 12,
                  family: "'Inter', sans-serif",
                },
                color: "#9ca3af",
              },
            },
          },
        };

        // Paleta con color principal #9d2449
        const statusColors = {
          "2xx": "#6b7280",
          "3xx": "#9d2449",
          "4xx": "#9ca3af",
          "5xx": "#7f1d1d",
        };

        // Gr√°fica de distribuci√≥n por c√≥digo de estado
        charts.status = new Chart(document.getElementById("statusChart"), {
          type: "doughnut",
          data: {
            labels: Object.keys(stats.byStatus),
            datasets: [
              {
                data: Object.values(stats.byStatus),
                backgroundColor: Object.keys(stats.byStatus).map(
                  (status) => statusColors[status]
                ),
                borderWidth: 3,
                borderColor: "#1f1f1f",
              },
            ],
          },
          options: chartOptions,
        });

        // Gr√°fica de distribuci√≥n por m√©todo HTTP
        charts.method = new Chart(document.getElementById("methodChart"), {
          type: "pie",
          data: {
            labels: Object.keys(stats.byMethod),
            datasets: [
              {
                data: Object.values(stats.byMethod),
                backgroundColor: [
                  "#6b7280",
                  "#9d2449",
                  "#9ca3af",
                  "#7f1d1d",
                  "#525252",
                ],
                borderWidth: 3,
                borderColor: "#1f1f1f",
              },
            ],
          },
          options: chartOptions,
        });

        // Gr√°fica de endpoints m√°s utilizados
        charts.endpoints = new Chart(
          document.getElementById("endpointsChart"),
          {
            type: "bar",
            data: {
              labels: Object.keys(stats.topEndpoints),
              datasets: [
                {
                  label: "Cantidad de solicitudes",
                  data: Object.values(stats.topEndpoints),
                  backgroundColor: "#4b5563",
                  borderColor: "#6b7280",
                  borderWidth: 2,
                },
              ],
            },
            options: {
              ...chartOptions,
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    color: "#9ca3af",
                    font: {
                      family: "'Inter', sans-serif",
                    },
                  },
                  grid: {
                    color: "#2d2d2d",
                  },
                },
                x: {
                  ticks: {
                    color: "#9ca3af",
                    font: {
                      family: "'Inter', sans-serif",
                    },
                  },
                  grid: {
                    color: "#2d2d2d",
                  },
                },
              },
            },
          }
        );
      }

      function renderTable(logs) {
        const tbody = document.querySelector("#logsTable tbody");
        tbody.innerHTML = "";

        logs.forEach((log) => {
          const row = document.createElement("tr");

          const date = new Date(log.timestamp);
          const formattedDate = date.toLocaleString("es-MX");

          const statusClass = getStatusClass(log.statusCode);
          const methodClass = `method-${log.method}`;

          row.innerHTML = `
            <td>${formattedDate}</td>
            <td><span class="method-badge ${methodClass}">${
            log.method
          }</span></td>
            <td>${log.url}</td>
            <td><span class="status-badge ${statusClass}">${
            log.statusCode
          }</span></td>
            <td>${log.duration}ms</td>
            <td>${log.ip || "N/A"}</td>
          `;

          tbody.appendChild(row);
        });
      }

      function getStatusClass(statusCode) {
        if (statusCode >= 200 && statusCode < 300) return "status-success";
        if (statusCode >= 300 && statusCode < 400) return "status-redirect";
        if (statusCode >= 400 && statusCode < 500) return "status-client-error";
        if (statusCode >= 500) return "status-server-error";
        return "";
      }

      function renderAgendaTable(logs) {
        const tbody = document.querySelector("#agendaLogsTable tbody");
        tbody.innerHTML = "";

        logs.forEach((log) => {
          const row = document.createElement("tr");

          const date = new Date(log.timestamp);
          const formattedDate = date.toLocaleString("es-MX");

          const estadoClass = getAgendaEstadoClass(log.estado);
          const duracionFormateada = formatDuration(log.duracion);

          row.innerHTML = `
            <td>${formattedDate}</td>
            <td><strong>${formatTareaName(log.tarea)}</strong></td>
            <td><span class="agenda-badge ${estadoClass}">${
            log.estado
          }</span></td>
            <td>${log.mensaje || "N/A"}</td>
            <td>${log.registrosProcesados || 0}</td>
            <td style="color: #10b981;">${log.registrosExitosos || 0}</td>
            <td style="color: #ef4444;">${log.registrosErrores || 0}</td>
            <td>${duracionFormateada}</td>
          `;

          tbody.appendChild(row);
        });
      }

      function getAgendaEstadoClass(estado) {
        const clases = {
          completado: "estado-completado",
          error: "estado-error",
          iniciado: "estado-iniciado",
          omitido: "estado-omitido",
        };
        return clases[estado] || "";
      }

      function formatTareaName(tarea) {
        const nombres = {
          bajasExtemporaneas: "Bajas Extempor√°neas",
          altasExtemporaneas: "Altas Extempor√°neas",
          licenciasExtemporaneas: "Licencias Extempor√°neas",
          crearTalones: "Crear Talones",
          gestionarPeriodoVacacional: "Gestionar Per√≠odo Vacacional",
        };
        return nombres[tarea] || tarea;
      }

      function formatDuration(duracion) {
        if (!duracion) return "N/A";
        if (duracion >= 1000) {
          return (duracion / 1000).toFixed(2) + "s";
        }
        return duracion + "ms";
      }

      // Funciones para el modal de errores
      async function showErrorModal(category, title) {
        const modal = document.getElementById("errorModal");
        const modalTitle = document.getElementById("modalTitle");
        const modalBody = document.getElementById("modalBody");

        modalTitle.textContent = title;
        modalBody.innerHTML =
          '<div style="text-align: center; padding: 20px;"><div style="color: #9ca3af;">Cargando errores...</div></div>';
        modal.style.display = "block";

        try {
          const res = await fetch(`/api/monitor/logs/${category}`);
          const data = await res.json();

          if (data.logs && data.logs.length > 0) {
            let html = "";
            data.logs.forEach((log) => {
              const date = new Date(log.timestamp);
              const formattedDate = date.toLocaleString("es-MX");

              html += `
                <div class="error-item">
                  <div class="error-header">
                    <span class="error-code">${log.statusCode}</span>
                    <span class="error-time">${formattedDate}</span>
                  </div>
                  <div>
                    <span class="error-method">${log.method || "N/A"}</span>
                    <span class="error-url">${log.url || "N/A"}</span>
                  </div>
                  ${
                    log.error
                      ? `<div class="error-description"><strong>Error:</strong> ${log.error}</div>`
                      : ""
                  }
                  ${
                    log.ip
                      ? `<div class="error-description"><strong>IP:</strong> ${log.ip}</div>`
                      : ""
                  }
                  ${
                    log.userAgent
                      ? `<div class="error-description"><strong>User Agent:</strong> ${log.userAgent}</div>`
                      : ""
                  }
                </div>
              `;
            });
            modalBody.innerHTML = html;
          } else {
            modalBody.innerHTML =
              '<div class="no-errors">No hay errores registrados en esta categor√≠a</div>';
          }
        } catch (error) {
          modalBody.innerHTML =
            '<div class="no-errors" style="color: #ef4444;">Error al cargar los datos</div>';
          console.error("Error cargando errores:", error);
        }
      }

      function closeModal() {
        document.getElementById("errorModal").style.display = "none";
      }

      // Cerrar modal al hacer click fuera de √©l
      window.onclick = function (event) {
        const modal = document.getElementById("errorModal");
        if (event.target == modal) {
          closeModal();
        }
      };

      // Agregar event listeners a las tarjetas de errores
      document.addEventListener("DOMContentLoaded", function () {
        const clientErrorCard = document.querySelector(
          ".stat-card.client-error"
        );
        const serverErrorCard = document.querySelector(
          ".stat-card.server-error"
        );

        if (clientErrorCard) {
          clientErrorCard.addEventListener("click", function () {
            showErrorModal("logs_400", "Errores del Cliente (4xx)");
          });
        }

        if (serverErrorCard) {
          serverErrorCard.addEventListener("click", function () {
            showErrorModal("logs_500", "Errores del Servidor (5xx)");
          });
        }
      });

      // Activar bot√≥n secreto con triple click en el header
      let clickCount = 0;
      let clickTimer = null;

      document
        .querySelector(".header h1")
        .addEventListener("click", function () {
          clickCount++;

          if (clickCount === 1) {
            clickTimer = setTimeout(() => {
              clickCount = 0;
            }, 800);
          } else if (clickCount === 3) {
            clearTimeout(clickTimer);
            clickCount = 0;
            document.getElementById("secretCleanBtn").classList.add("visible");
            setTimeout(() => {
              document
                .getElementById("secretCleanBtn")
                .classList.remove("visible");
            }, 5000);
          }
        });

      // Funci√≥n para limpiar logs (requiere confirmaci√≥n)
      async function cleanLogs() {
        const confirmClean = confirm(
          "‚ö†Ô∏è ¬øEst√°s seguro de que deseas limpiar TODOS los logs?\n\nEsta acci√≥n NO se puede deshacer."
        );

        if (confirmClean) {
          const doubleConfirm = confirm(
            "üî¥ √öLTIMA CONFIRMACI√ìN\n\n¬øRealmente deseas eliminar todos los registros de logs?"
          );

          if (doubleConfirm) {
            try {
              const response = await fetch("/api/monitor/clean", {
                method: "DELETE",
              });

              const result = await response.json();

              if (response.ok) {
                alert("‚úÖ " + result.message);
                // Recargar los datos para reflejar los cambios
                loadData();
              } else {
                alert("‚ùå Error: " + result.error);
              }

              document
                .getElementById("secretCleanBtn")
                .classList.remove("visible");
            } catch (error) {
              alert("‚ùå Error al intentar limpiar los logs");
              console.error("Error:", error);
            }
          }
        }
      }

      // Cargar datos al inicio
      loadData();

      // Actualizar cada 30 segundos
      setInterval(loadData, 30000);
    </script>
  </body>
</html>
