<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Monitor del Servidor - SIRH</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #0a0a0a;
        min-height: 100vh;
        padding: 20px;
        color: #e5e7eb;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      .header {
        background: linear-gradient(135deg, #1a1a1a 0%, #2d1a23 100%);
        padding: 35px;
        border-radius: 12px;
        border: 1px solid #9d2449;
        margin-bottom: 30px;
        text-align: center;
        box-shadow: 0 10px 40px rgba(157, 36, 73, 0.2);
      }

      .header h1 {
        color: #ffffff;
        font-size: 2.8em;
        margin-bottom: 8px;
        font-weight: 700;
        letter-spacing: -1px;
      }

      .header p {
        color: #9ca3af;
        font-size: 1.05em;
        font-weight: 400;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: linear-gradient(135deg, #1f1f1f 0%, #2a2a2a 100%);
        padding: 30px;
        border-radius: 10px;
        border: 1px solid #333;
        text-align: center;
        transition: all 0.3s ease;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
        position: relative;
        overflow: hidden;
      }

      .stat-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #9d2449, #c92d5f, #9d2449);
      }

      .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 30px rgba(157, 36, 73, 0.4);
        border-color: #9d2449;
      }

      .stat-card h3 {
        color: #9ca3af;
        font-size: 0.85em;
        text-transform: uppercase;
        margin-bottom: 15px;
        letter-spacing: 1.5px;
        font-weight: 600;
      }

      .stat-card .value {
        color: #ffffff;
        font-size: 3em;
        font-weight: 700;
        letter-spacing: -1.5px;
        margin-bottom: 8px;
      }

      .stat-card .label {
        color: #6b7280;
        font-size: 0.85em;
        font-weight: 500;
      }

      .stat-card.success .value {
        color: #d1d5db;
      }
      .stat-card.success::before {
        background: linear-gradient(90deg, #4b5563, #6b7280, #4b5563);
      }

      .stat-card.redirects .value {
        color: #9ca3af;
      }
      .stat-card.redirects::before {
        background: linear-gradient(90deg, #374151, #4b5563, #374151);
      }

      .stat-card.client-error .value {
        color: #e5e7eb;
      }
      .stat-card.client-error::before {
        background: linear-gradient(90deg, #525252, #737373, #525252);
      }

      .stat-card.server-error .value {
        color: #fca5a5;
      }
      .stat-card.server-error::before {
        background: linear-gradient(90deg, #7f1d1d, #991b1b, #7f1d1d);
      }

      .stat-card.total .value {
        color: #ffffff;
      }
      .stat-card.total::before {
        background: linear-gradient(90deg, #9d2449, #d63468, #9d2449);
      }

      .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .chart-card {
        background: linear-gradient(135deg, #1f1f1f 0%, #2a2a2a 100%);
        padding: 30px;
        border-radius: 10px;
        border: 1px solid #333;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
      }

      .chart-card h2 {
        color: #ffffff;
        margin-bottom: 25px;
        font-size: 1.25em;
        font-weight: 600;
        letter-spacing: -0.5px;
        padding-bottom: 15px;
        border-bottom: 2px solid #9d2449;
      }

      .chart-container {
        position: relative;
        height: 300px;
      }

      .table-card {
        background: linear-gradient(135deg, #1f1f1f 0%, #2a2a2a 100%);
        padding: 30px;
        border-radius: 10px;
        border: 1px solid #333;
        overflow-x: auto;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
        margin-bottom: 30px;
      }

      .table-card h2 {
        color: #ffffff;
        margin-bottom: 25px;
        font-size: 1.25em;
        font-weight: 600;
        letter-spacing: -0.5px;
        padding-bottom: 15px;
        border-bottom: 2px solid #9d2449;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th {
        background: #2d2d2d;
        color: #9ca3af;
        padding: 15px;
        text-align: left;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75em;
        letter-spacing: 1.2px;
        border-bottom: 2px solid #404040;
      }

      td {
        padding: 15px;
        border-bottom: 1px solid #2d2d2d;
        color: #d1d5db;
        font-size: 0.9em;
      }

      tr:hover {
        background: #252525;
      }

      .status-badge {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 6px;
        font-size: 0.8em;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .status-success {
        background: #374151;
        color: #d1d5db;
        border: 1px solid #4b5563;
      }

      .status-redirect {
        background: #1f2937;
        color: #9ca3af;
        border: 1px solid #374151;
      }

      .status-client-error {
        background: #3f3f3f;
        color: #e5e7eb;
        border: 1px solid #525252;
      }

      .status-server-error {
        background: #450a0a;
        color: #fca5a5;
        border: 1px solid #7f1d1d;
      }

      .loading {
        text-align: center;
        color: #9ca3af;
        font-size: 1.3em;
        padding: 60px;
      }

      .refresh-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        background: linear-gradient(135deg, #9d2449 0%, #b82d54 100%);
        color: #ffffff;
        border: 1px solid #c92d5f;
        padding: 15px 28px;
        border-radius: 8px;
        font-size: 0.95em;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 10px 30px rgba(157, 36, 73, 0.5);
        transition: all 0.3s ease;
        letter-spacing: 0.3px;
      }

      .refresh-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 15px 40px rgba(157, 36, 73, 0.7);
        background: linear-gradient(135deg, #b82d54 0%, #d63468 100%);
      }

      .method-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 0.75em;
        font-weight: 700;
        margin-right: 10px;
        letter-spacing: 0.5px;
      }

      .method-GET {
        background: #374151;
        color: #d1d5db;
        border: 1px solid #4b5563;
      }

      .method-POST {
        background: #9d2449;
        color: #ffffff;
        border: 1px solid #c92d5f;
      }

      .method-PUT {
        background: #525252;
        color: #f3f4f6;
        border: 1px solid #737373;
      }

      .method-DELETE {
        background: #7f1d1d;
        color: #fca5a5;
        border: 1px solid #991b1b;
      }

      .method-PATCH {
        background: #3f3f46;
        color: #e4e4e7;
        border: 1px solid #52525b;
      }

      @media (max-width: 768px) {
        .charts-grid {
          grid-template-columns: 1fr;
        }

        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
        }

        .refresh-btn {
          bottom: 20px;
          right: 20px;
          padding: 12px 20px;
          font-size: 0.9em;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Monitor del Servidor SIRH</h1>
        <p>Sistema de monitoreo en tiempo real</p>
      </div>

      <div id="loading" class="loading">Cargando datos del servidor...</div>

      <div id="content" style="display: none">
        <!-- Tarjetas de estadísticas -->
        <div class="stats-grid">
          <div class="stat-card total">
            <h3>Total de Solicitudes</h3>
            <div class="value" id="stat-total">0</div>
            <div class="label">Todas las peticiones</div>
          </div>
          <div class="stat-card success">
            <h3>Solicitudes Exitosas</h3>
            <div class="value" id="stat-2xx">0</div>
            <div class="label">Códigos 2xx</div>
          </div>
          <div class="stat-card redirects">
            <h3>Redirecciones</h3>
            <div class="value" id="stat-3xx">0</div>
            <div class="label">Códigos 3xx</div>
          </div>
          <div class="stat-card client-error">
            <h3>Errores del Cliente</h3>
            <div class="value" id="stat-4xx">0</div>
            <div class="label">Códigos 4xx</div>
          </div>
          <div class="stat-card server-error">
            <h3>Errores del Servidor</h3>
            <div class="value" id="stat-5xx">0</div>
            <div class="label">Códigos 5xx</div>
          </div>
        </div>

        <!-- Gráficas -->
        <div class="charts-grid">
          <div class="chart-card">
            <h2>Distribución por Código de Estado</h2>
            <div class="chart-container">
              <canvas id="statusChart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <h2>Distribución por Método HTTP</h2>
            <div class="chart-container">
              <canvas id="methodChart"></canvas>
            </div>
          </div>
        </div>

        <div class="chart-card">
          <h2>Endpoints Más Utilizados</h2>
          <div class="chart-container">
            <canvas id="endpointsChart"></canvas>
          </div>
        </div>

        <!-- Tabla de registros recientes -->
        <div class="table-card">
          <h2>Registros Recientes</h2>
          <table id="logsTable">
            <thead>
              <tr>
                <th>Fecha/Hora</th>
                <th>Método</th>
                <th>URL</th>
                <th>Estado</th>
                <th>Duración</th>
                <th>IP</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <button class="refresh-btn" onclick="loadData()">Actualizar Datos</button>
    </div>

    <script>
      let charts = {};

      async function loadData() {
        try {
          // Cargar estadísticas
          const statsRes = await fetch("/api/monitor/stats");
          const stats = await statsRes.json();

          // Actualizar tarjetas de estadísticas
          document.getElementById("stat-total").textContent = stats.total;
          document.getElementById("stat-2xx").textContent =
            stats.byStatus["2xx"];
          document.getElementById("stat-3xx").textContent =
            stats.byStatus["3xx"];
          document.getElementById("stat-4xx").textContent =
            stats.byStatus["4xx"];
          document.getElementById("stat-5xx").textContent =
            stats.byStatus["5xx"];

          // Cargar logs recientes
          const logsRes = await fetch("/api/monitor/recent");
          const logs = await logsRes.json();

          renderTable(logs);
          renderCharts(stats);

          document.getElementById("loading").style.display = "none";
          document.getElementById("content").style.display = "block";
        } catch (error) {
          console.error("Error cargando datos:", error);
          document.getElementById("loading").innerHTML =
            '<span style="color: #ef4444;">Error al cargar los datos del servidor</span>';
        }
      }

      function renderCharts(stats) {
        // Destruir gráficas existentes
        Object.values(charts).forEach((chart) => chart.destroy());
        charts = {};

        // Configuración base para gráficas con tema oscuro
        const chartOptions = {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: "bottom",
              labels: {
                padding: 15,
                font: {
                  size: 12,
                  family: "'Inter', sans-serif",
                },
                color: "#9ca3af",
              },
            },
          },
        };

        // Paleta con color principal #9d2449
        const statusColors = {
          "2xx": "#6b7280",
          "3xx": "#9d2449",
          "4xx": "#9ca3af",
          "5xx": "#7f1d1d",
        };

        // Gráfica de distribución por código de estado
        charts.status = new Chart(document.getElementById("statusChart"), {
          type: "doughnut",
          data: {
            labels: Object.keys(stats.byStatus),
            datasets: [
              {
                data: Object.values(stats.byStatus),
                backgroundColor: Object.keys(stats.byStatus).map(
                  (status) => statusColors[status]
                ),
                borderWidth: 3,
                borderColor: "#1f1f1f",
              },
            ],
          },
          options: chartOptions,
        });

        // Gráfica de distribución por método HTTP
        charts.method = new Chart(document.getElementById("methodChart"), {
          type: "pie",
          data: {
            labels: Object.keys(stats.byMethod),
            datasets: [
              {
                data: Object.values(stats.byMethod),
                backgroundColor: [
                  "#6b7280",
                  "#9d2449",
                  "#9ca3af",
                  "#7f1d1d",
                  "#525252",
                ],
                borderWidth: 3,
                borderColor: "#1f1f1f",
              },
            ],
          },
          options: chartOptions,
        });

        // Gráfica de endpoints más utilizados
        charts.endpoints = new Chart(
          document.getElementById("endpointsChart"),
          {
            type: "bar",
            data: {
              labels: Object.keys(stats.topEndpoints),
              datasets: [
                {
                  label: "Cantidad de solicitudes",
                  data: Object.values(stats.topEndpoints),
                  backgroundColor: "#4b5563",
                  borderColor: "#6b7280",
                  borderWidth: 2,
                },
              ],
            },
            options: {
              ...chartOptions,
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    color: "#9ca3af",
                    font: {
                      family: "'Inter', sans-serif",
                    },
                  },
                  grid: {
                    color: "#2d2d2d",
                  },
                },
                x: {
                  ticks: {
                    color: "#9ca3af",
                    font: {
                      family: "'Inter', sans-serif",
                    },
                  },
                  grid: {
                    color: "#2d2d2d",
                  },
                },
              },
            },
          }
        );
      }

      function renderTable(logs) {
        const tbody = document.querySelector("#logsTable tbody");
        tbody.innerHTML = "";

        logs.forEach((log) => {
          const row = document.createElement("tr");

          const date = new Date(log.timestamp);
          const formattedDate = date.toLocaleString("es-MX");

          const statusClass = getStatusClass(log.statusCode);
          const methodClass = `method-${log.method}`;

          row.innerHTML = `
            <td>${formattedDate}</td>
            <td><span class="method-badge ${methodClass}">${
            log.method
          }</span></td>
            <td>${log.url}</td>
            <td><span class="status-badge ${statusClass}">${
            log.statusCode
          }</span></td>
            <td>${log.duration}ms</td>
            <td>${log.ip || "N/A"}</td>
          `;

          tbody.appendChild(row);
        });
      }

      function getStatusClass(statusCode) {
        if (statusCode >= 200 && statusCode < 300) return "status-success";
        if (statusCode >= 300 && statusCode < 400) return "status-redirect";
        if (statusCode >= 400 && statusCode < 500) return "status-client-error";
        if (statusCode >= 500) return "status-server-error";
        return "";
      }

      // Cargar datos al inicio
      loadData();

      // Actualizar cada 30 segundos
      setInterval(loadData, 30000);
    </script>
  </body>
</html>
